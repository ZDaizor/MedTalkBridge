<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.bizcase.mapper.CaseTypeDistributionMapper">

    <resultMap type="com.ruoyi.bizcase.domain.CaseTypeDistribution" id="CaseTypeDistributionResult">
        <result property="caseType"        column="case_type" />
        <result property="completedCount"  column="completed_count" />
        <result property="percentage"      column="percentage" />
    </resultMap>

    <!-- 查询病例类型分布 -->
    <select id="selectCaseTypeDistribution" resultMap="CaseTypeDistributionResult">
        SELECT 
            c.case_name AS case_type,
            COUNT(*) AS completed_count,
            ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) AS percentage
        FROM 
            biz_consultation_sessions s
        JOIN 
            biz_case c ON s.case_id = c.case_id
        WHERE 
            s.status = 1  -- 只统计已完成的会话
        GROUP BY 
            c.case_name
        ORDER BY 
            completed_count DESC
    </select>

</mapper>